<script src="https://unpkg.com/vue@3"></script>
<script src="./papaparse.min.js"></script>
<link rel="stylesheet" href="globalStylesheet.css">
<link rel="stylesheet" href="boxAStylesheet.css">
<link rel="stylesheet" href="boxBStylesheet.css">

<div id="app">
  <div class="outerDiv">
    <div class="innerDiv">
      <div class="boxA">
        <div @click="firstTabSelected=true" class="tab" :class="{ selectedTab: firstTabSelected}"><span class="topHeading">Urval</span></div>
        <div @click="firstTabSelected=false" class="tab" :class="{ selectedTab: !firstTabSelected}"><span class="topHeading">Översikt</span></div>
        <div v-if="firstTabSelected" class="tabContent firstTabContent" :class="{ tabContentExpanded: g_expanded}">
          <div class="aboveLists heading">
            <span class="heading">Utdelningstillfälle</span><div class="fakeTimeSelectionBox">08:00 2022-03-04 <button>...</button></div>
            <img v-if="!g_expanded" @click="g_expanded = !g_expanded" id="G_expand" class="G" src="./assets/images/Expand.png"></img>
            <img v-else @click="g_expanded = !g_expanded" id="G_contract" class="G" src="./assets/images/contract.png"></img>
          </div>
          <div class="topList">
            <table class="list">
              <thead>
                <tr class="headerRow heading">
                  <th style="width:50ch; width: 40ch">Ordination</th>
                  <th style="width:35ch">Beredningsform</th>
                  <th style="width:20ch">Dos</th>
                  <th style="width:2em">Sta</th>
                  <th style="width:2em">G</th>
                  <th style="width:25ch">Info</th>
                  <th style="width:2em">Aut</th>
                  <th style="width:2em">Kyl</th>
                </tr>
              </thead>
              <tbody>
                <tr @click="selectRow(row)" v-for="(row, index) in currentPatientMedicines_8oclock" :class="{ selectedRow: isSelectedRow(row) }" class="valueRow">
                  <td><div class="valueCell value">{{row['Namn'] + ' ' + row['Styrka']}}</div></td>
                  <td><div class="valueCell value">{{row['Beredningsform, kortversion'] != '' ? row['Beredningsform, kortversion'] : row['Beredningsform']}}</div></td>
                  <td><div class="valueCell value">{{this.currentPatientPrescriptions[index]["Kortform Dosering"]}}</div></td>
                  <td><div class="valueCell value" style="overflow:hidden">
                    <img v-if="row['Leveranstyp']==1" height="21" src="./assets/images/A_Sta_1.png">
                    <img v-if="row['Leveranstyp']==2" height="21" src="./assets/images/A_Sta_2.png">
                  </div></td>
                  <td><div class="valueCell value">{{row['G']}}</div></td>
                  <td><div class="valueCell value">{{row['Info']}}</div></td>
                  <td><div class="valueCell value">{{row['I automat'] == '1' ? '1' : ''}}</div></td>
                  <td><div class="valueCell value">{{row['Kylförvaras'] == '1' ? '1' : ''}}</div></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="bottomList">
            <table class="list">
              <thead>
                <tr class="headerRow heading">
                  <th style="width:50ch; width: 40ch">Ej tidssatta ordinationer</th>
                  <th style="width:35ch">Bered.form</th>
                  <th style="width:20ch">Dos</th>
                  <th style="width:2em">Sta</th>
                  <th style="width:2em">G</th>
                  <th style="width:25ch">Info</th>
                  <th style="width:2em">Aut</th>
                  <th style="width:2em">Kyl</th>
                </tr>
              </thead>
              <tbody>
                <tr @click="selectRow(row)" v-for="(row, index) in currentPatientMedicines_noTime" :class="{ selectedRow: isSelectedRow(row) }" class="valueRow">
                  <td><div class="valueCell value">{{row['Namn'] + ' ' + row['Styrka']}}</div></td>
                  <td><div class="valueCell value">{{row['Beredningsform, kortversion'] != '' ? row['Beredningsform, kortversion'] : row['Beredningsform']}}</div></td>
                  <td><div class="valueCell value">{{this.currentPatientPrescriptions[index]["Kortform Dosering"]}}</div></td>
                  <td><div class="valueCell value" style="overflow:hidden">
                    <img v-if="row['Leveranstyp']==1" height="21" src="./assets/images/A_Sta_1.png">
                    <img v-if="row['Leveranstyp']==2" height="21" src="./assets/images/A_Sta_2.png">
                  </div></td>
                  <td><div class="valueCell value">{{row['G']}}</div></td>
                  <td><div class="valueCell value">{{row['Info']}}</div></td>
                  <td><div class="valueCell value">{{row['I automat'] == '1' ? '1' : ''}}</div></td>
                  <td><div class="valueCell value">{{row['Kylförvaras'] == '1' ? '1' : ''}}</div></td>
                </tr>
                <tr @click="selectRow(row)" v-for="(row, index) in generalMedicines" :class="{ selectedRow: isSelectedRow(row) }" class="valueRow">
                  <td><div class="valueCell value">{{row['Namn'] + ' ' + row['Styrka']}}</div></td>
                  <td><div class="valueCell value">{{row['Beredningsform, kortversion'] != '' ? row['Beredningsform, kortversion'] : row['Beredningsform']}}</div></td>
                  <td><div class="valueCell value">{{this.generalPrescriptions[index]["Kortform Dosering"]}}</div></td>
                  <td><div class="valueCell value" style="overflow:hidden">
                    <img v-if="row['Leveranstyp']==1" height="21" src="./assets/images/A_Sta_1.png">
                    <img v-if="row['Leveranstyp']==2" height="21" src="./assets/images/A_Sta_2.png">
                  </div></td>
                  <td><div class="valueCell value">{{row['G']}}</div></td>
                  <td><div class="valueCell value">{{row['Info']}}</div></td>
                  <td><div class="valueCell value">{{row['I automat'] == '1' ? '1' : ''}}</div></td>
                  <td><div class="valueCell value">{{row['Kylförvaras'] == '1' ? '1' : ''}}</div></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-if="g_expanded" class="G-Content">

          </div>
        </div>
        <div v-else class="tabContent secondTabContent">
          <!-- TODO -->
        </div>
      </div>
      <div class="boxB">

      </div>
      <button id="administrationButton">Till Administrering</button>
    </div>
  </div>
</div>

<script>
  Vue.createApp({
    data() {
      return {
        medicines: [],
        prescriptions: [],
        generalPrescriptions: [],
        generalMedicines:[],
        currentPatientPrescriptions: [],
        currentPatientMedicines: [],
        currentPatientMedicines_8oclock: [],
        currentPatientMedicines_noTime: [],
        currentPatientId: 'P1',
        firstTabSelected:true,
        g_expanded: false,
        selectedRow: null,
      }
    },
    mounted() {
      fetch('./assets/data/Läkemedel.csv')
      .then(response => response.text())
      .then(text => {
        Papa.parse(text, {
          complete: results => {
            this.medicines = results.data;
          },
          header:true
        });
      })
      fetch('./assets/data/Ordinationer.csv')
      .then(response => response.text())
      .then(text => {
        Papa.parse(text, {
          complete: results => {
            this.prescriptions = results.data;
          },
          header: true
        });
      })
      fetch('./assets/data/Generella_ordinationer.csv')
        .then(response => response.text())
        .then(text => {
          Papa.parse(text, {
            complete: results => {
              this.generalPrescriptions = results.data;
            },
            header: true
          });
        })
      .then(a => {
        for (const prescription of this.prescriptions) {
          if (prescription['PatientId'] == this.currentPatientId) {
            this.currentPatientPrescriptions.push(prescription);
            medicineId = prescription['LäkemedelsId']
            for (const medicine of this.medicines) {
              if (medicine['LäkemedelsId'] == medicineId) {
                medicineCopy = this.addCustomProperties(medicine, prescription);
                this.currentPatientMedicines.push(medicineCopy);
                if(prescription['Aktuell kl 08:00'] == '1'){
                  this.currentPatientMedicines_8oclock.push(medicineCopy);
                }
                else if(prescription['Vid behov'] == '1' || prescription['Ej tidssatta'] == '1'){
                  this.currentPatientMedicines_noTime.push(medicineCopy);
                }
                continue;
              }
            }
          }
        }
        for (const prescription of this.generalPrescriptions) {
            medicineId = prescription['LäkemedelsId']
            for (const medicine of this.medicines) {
              if (medicine['LäkemedelsId'] == medicineId) {
                medicineCopy = this.addCustomProperties(medicine, prescription);
                this.generalMedicines.push(medicineCopy);
            }
          }
        }
        console.log(this.currentPatientPrescriptions);
        console.log(this.generalPrescriptions);
        console.log(this.currentPatientMedicines);
        console.log(this.generalMedicines);
        console.log(this.currentPatientMedicines_8oclock);
        console.log(this.currentPatientMedicines_noTime);
      })
    },
    methods: {
      selectRow: function(row){
        if (this.selectedRow == row) {
          this.selectedRow = null;
        }
        else{
          this.selectedRow = row;
        }
      },
      isSelectedRow: function(row){
        return this.selectedRow == row;
      },
      addCustomProperties(medicine, prescription, isPersonalPrescription){
        medicineCopy = JSON.parse(JSON.stringify(medicine));
        medicineCopy['Läkemedel valt'] = medicineCopy['Leveranstyp'] <= 2;
        medicineCopy['G'] = medicineCopy['Läkemedel valt'] ? 'G' : 'g';
        if (prescription['Har utbyte skett'] == '0') { medicineCopy['G'] = '' };
        if (medicineCopy['G'] == '' || 
            (medicineCopy['G'] == 'g' &&
            medicineCopy['Kan bytas mot'] != '' &&
            // I am very sorry about this following line
            this.medicines.filter(med => med['LäkemedelsId'] == (medicineCopy['Kan bytas mot'].split(', ')[0]))[0]['Finns på'].split(', ').filter(locationId => locationId=='PL1')).length > 0) {
          medicineCopy['Info'] = 'Finns';
        }
        return medicineCopy;
      }
    },
    computed: {

    },
  }).mount('#app')

</script>